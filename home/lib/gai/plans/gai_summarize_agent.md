---
prompt: |
  Can you help me start running a new gai "summarize" agent that creates amend messages / header lines for HISTORY entries based on the prompt below?
  + Add a `gai run summarize` workflow command that accepts a file to summarize as an argument and runs the "summarize" agent on it.
  + Replace `<usage>` with another argument that describes how the summary will be used (ex: "a commit message header").
  + The `crs` workflow should automatically use this when constructing the header message for the proposed HISTORY entry.
    The same goes for the header messages created after fix-hook agent runs (retain all current information plus add the summary).
  + `gai loop` should automatically run this when hook commands that are prefixed with `!` fail to construct `<msg>` in
  the `- (!: <msg>)` suffix that gets added to the associated hook status line. This should replace the current `- (!:
  Hook Command Failed)` suffix with `- (!: <summary>)` where `<summary>` is generated by the summarize agent.
  
  ##### PROMPT
  ```
  Can you help me summarize the @<target_file> file in <=20 words (preferably <=15 or even <=10 words)? This summary will
  be used as <usage>.
```
---

# Summarize Agent Implementation Plan

## Overview
Add a "summarize" agent that produces concise (<=20 word) summaries for HISTORY entry headers and hook failure suffixes.

## Design Decisions
- **Model size**: Large model (`model_size="big"`) for quality
- **Header format**: Append after brackets: `[crs (ref)] Summary text`
- **CLI output**: Print summary only to stdout
- **Fallback**: Gracefully fall back to existing behavior on failure

---

## Phase 1: Core Summarize Workflow

### 1.1 Create `home/lib/gai/summarize_workflow.py`

```python
class SummarizeWorkflow(BaseWorkflow):
    def __init__(self, target_file: str, usage: str, suppress_output: bool = False)
    # Uses GeminiCommandWrapper with model_size="big"
    # Stores result in self.summary
```

**Prompt template:**
```
Can you help me summarize the @<target_file> file in <=20 words (preferably <=15 or even <=10 words)? This summary will be used as <usage>.

IMPORTANT: Output ONLY the summary itself, with no additional text, prefixes, or explanations.
```

### 1.2 Create `home/lib/gai/summarize_utils.py`

```python
def get_file_summary(target_file: str, usage: str, fallback: str) -> str:
    """Get summary with fallback on failure."""
```

### 1.3 Add CLI in `home/lib/gai/main.py`

Add `gai run summarize <file> <usage>` subparser (after line ~270, following other run subcommands).

Print only the summary to stdout (no extra context).

---

## Phase 2: Hook Failure Integration

### Modify `home/lib/gai/work/hooks/operations.py`

**Lines 369-372** - Replace hardcoded "Hook Command Failed":

```python
# Current:
auto_skip_suffix = "Hook Command Failed"

# New:
from summarize_utils import get_file_summary
auto_skip_suffix = get_file_summary(
    target_file=output_path,
    usage="a hook failure suffix in a HISTORY entry",
    fallback="Hook Command Failed",
)
```

---

## Phase 3: CRS Workflow Integration

### Modify `home/lib/gai/loop_crs_runner.py`

**Lines 101-115** - Add summary to workflow_note:

```python
# After workflow runs successfully, before create_proposal_from_changes:
summary = get_file_summary(
    target_file=workflow.response_path,
    usage="a HISTORY entry header describing CRS changes",
    fallback="",
)
if summary:
    workflow_note = f"[crs ({comments_ref})] {summary}"
else:
    workflow_note = f"[crs ({comments_ref})]"
```

---

## Phase 4: Fix-Hook Workflow Integration

### Modify `home/lib/gai/loop_fix_hook_runner.py`

**Lines 109-115** - Add summary to workflow_note:

```python
# Save response to temp file, summarize, then build note:
summary = get_file_summary(
    target_file=temp_response_file,
    usage="a HISTORY entry header describing fix-hook changes",
    fallback="",
)
if summary:
    workflow_note = f"[fix-hook {history_ref} {run_hook_command}] {summary}"
else:
    workflow_note = f"[fix-hook {history_ref} {run_hook_command}]"
```

---

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `home/lib/gai/summarize_workflow.py` | Create | Core SummarizeWorkflow class |
| `home/lib/gai/summarize_utils.py` | Create | get_file_summary() helper |
| `home/lib/gai/main.py` | Modify | Add `gai run summarize` CLI |
| `home/lib/gai/work/hooks/operations.py` | Modify | Use summarize for hook failures |
| `home/lib/gai/loop_crs_runner.py` | Modify | Add summary to CRS workflow_note |
| `home/lib/gai/loop_fix_hook_runner.py` | Modify | Add summary to fix-hook workflow_note |
| `home/lib/gai/test/test_summarize_workflow.py` | Create | Unit tests |

---

## Implementation Order

1. Create `summarize_workflow.py` and `summarize_utils.py`
2. Add CLI to `main.py`, test with `gai run summarize`
3. Add tests in `test_summarize_workflow.py`
4. Modify `operations.py` for hook failures
5. Modify `loop_crs_runner.py` for CRS headers
6. Modify `loop_fix_hook_runner.py` for fix-hook headers
7. Run `make fix && make lint && make test`
8. Run `chezmoi apply`

---

## Quality Checks (after each change)

```bash
make fix
make lint
make test
chezmoi apply
```
