name: eval_ifs_loops

input:
  - name: run_conditional
    type: bool
    default: true
  - name: items
    type: string
    default: '["alpha", "beta", "gamma"]'
  - name: ids
    type: string
    default: '[1, 2, 3]'
  - name: max_retries
    type: int
    default: 3
  - name: max_polls
    type: int
    default: 5

steps:
  # 1. Test if: condition - true case
  - name: conditional_true
    bash: echo "value=executed"
    if: "{{ run_conditional }}"
    output: {value: word}

  # 2. Test if: condition - false case (skipped when run_conditional is false)
  - name: conditional_false
    bash: echo "value=should_skip"
    if: "{{ not run_conditional }}"
    output: {value: word}

  # 3. Test for: with single variable (default join: array)
  - name: process_items
    bash: 'echo "result={{ item }}"'
    for: {item: "{{ items }}"}
    output: {result: word}

  # 4. Test for: with multiple parallel variables
  - name: process_parallel
    bash: 'echo "name={{ name }},id={{ id }}"'
    for:
      name: "{{ items }}"
      id: "{{ ids }}"
    output: {name: word, id: word}

  # 5. Test for: with join: text
  - name: join_text
    bash: 'echo "line={{ item }}"'
    for: {item: "{{ items }}"}
    join: text
    output: {line: word}

  # 6. Test for: with join: lastOf
  - name: join_lastof
    bash: 'echo "final={{ item }}"'
    for: {item: "{{ items }}"}
    join: lastOf
    output: {final: word}

  # 7. Test for: with join: object
  - name: join_object
    bash: 'echo "key_{{ item }}=value_{{ item }}"'
    for: {item: "{{ items }}"}
    join: object

  # 8. Test repeat:/until: loop (simulated with counter)
  - name: retry_operation
    bash: |
      # Simulate success after a few tries based on max_retries
      counter_file="/tmp/test_workflow_retry_counter"
      if [ ! -f "$counter_file" ]; then echo "0" > "$counter_file"; fi
      count=$(cat "$counter_file")
      count=$((count + 1))
      echo "$count" > "$counter_file"
      if [ "$count" -ge "{{ max_retries }}" ]; then
        echo "success=true"
        echo "attempts=$count"
        rm -f "$counter_file"
      else
        echo "success=false"
        echo "attempts=$count"
      fi
    repeat:
      until: "{{ retry_operation.success }}"
      max: 10
    output: {success: bool, attempts: int}

  # 9. Test while: loop short form (simulated with counter)
  - name: poll_status
    bash: |
      # Simulate pending for a few polls then complete
      counter_file="/tmp/test_workflow_poll_counter"
      if [ ! -f "$counter_file" ]; then echo "0" > "$counter_file"; fi
      count=$(cat "$counter_file")
      count=$((count + 1))
      echo "$count" > "$counter_file"
      if [ "$count" -ge "{{ max_polls }}" ]; then
        echo "pending=false"
        echo "polls=$count"
        rm -f "$counter_file"
      else
        echo "pending=true"
        echo "polls=$count"
      fi
    while: "{{ poll_status.pending }}"
    output: {pending: bool, polls: int}

  # 10. Test while: loop long form with custom max
  - name: poll_with_max
    bash: |
      counter_file="/tmp/test_workflow_poll_max_counter"
      if [ ! -f "$counter_file" ]; then echo "0" > "$counter_file"; fi
      count=$(cat "$counter_file")
      count=$((count + 1))
      echo "$count" > "$counter_file"
      if [ "$count" -ge 2 ]; then
        echo "active=false"
        rm -f "$counter_file"
      else
        echo "active=true"
      fi
    while:
      condition: "{{ poll_with_max.active }}"
      max: 5
    output: {active: bool}

  # 11. Test if: combined with for: (conditional iteration)
  - name: conditional_loop
    bash: 'echo "conditional_result={{ item }}"'
    if: "{{ run_conditional }}"
    for: {item: "{{ items }}"}
    output: {conditional_result: word}

  # 12. Summary step to verify all results
  - name: summary
    bash: |
      echo "all_tests_completed=true"
      echo "conditional_true_ran={{ conditional_true.value }}"
      echo "items_processed={{ process_items | length }}"
      echo "retry_attempts={{ retry_operation.attempts }}"
      echo "poll_count={{ poll_status.polls }}"
    output: {all_tests_completed: bool}
