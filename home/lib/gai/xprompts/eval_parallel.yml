steps:
  # 1. Basic parallel execution - Two steps that sleep and complete in parallel
  - name: basic_parallel
    parallel:
      - name: task_a
        bash: |
          sleep 0.5
          echo "result=task_a_done"
        output: {result: word}
      - name: task_b
        bash: |
          sleep 0.5
          echo "result=task_b_done"
        output: {result: word}

  # 2. Verify basic parallel results (default join: object)
  - name: verify_basic
    bash: |
      echo "task_a_result={{ basic_parallel.task_a.result }}"
      echo "task_b_result={{ basic_parallel.task_b.result }}"
      echo "both_present={{ basic_parallel.task_a.result == 'task_a_done' and basic_parallel.task_b.result == 'task_b_done' }}"
    output: {both_present: bool}

  # 3. Test join: array mode
  - name: array_join
    parallel:
      - name: first
        bash: echo "value=one"
        output: {value: word}
      - name: second
        bash: echo "value=two"
        output: {value: word}
      - name: third
        bash: echo "value=three"
        output: {value: word}
    join: array

  # 4. Verify array join (results as array)
  - name: verify_array
    bash: |
      echo "count={{ array_join | length }}"
      echo "is_array=true"
    output: {count: int, is_array: bool}

  # 5. Test join: lastOf mode
  - name: lastof_join
    parallel:
      - name: early
        bash: echo "value=early_value"
        output: {value: word}
      - name: late
        bash: |
          sleep 0.2
          echo "value=late_value"
        output: {value: word}
    join: lastOf

  # 6. Verify lastOf join (only one result kept)
  - name: verify_lastof
    bash: |
      echo "value={{ lastof_join.value }}"
      echo "has_value={{ lastof_join.value is defined }}"
    output: {has_value: bool}

  # 7. Mixed step types - Bash and Python in parallel
  - name: mixed_types
    parallel:
      - name: bash_step
        bash: echo "source=bash"
        output: {source: word}
      - name: python_step
        python: |
          print("source=python")
        output: {source: word}

  # 8. Verify mixed types
  - name: verify_mixed
    bash: |
      echo "bash_source={{ mixed_types.bash_step.source }}"
      echo "python_source={{ mixed_types.python_step.source }}"
      echo "mixed_ok={{ mixed_types.bash_step.source == 'bash' and mixed_types.python_step.source == 'python' }}"
    output: {mixed_ok: bool}

  # 9. Parallel with if: condition
  - name: conditional_parallel
    if: true
    parallel:
      - name: cond_a
        bash: echo "ran=true"
        output: {ran: bool}
      - name: cond_b
        bash: echo "ran=true"
        output: {ran: bool}

  # 10. Verify conditional parallel
  - name: verify_conditional
    bash: |
      echo "both_ran={{ conditional_parallel.cond_a.ran and conditional_parallel.cond_b.ran }}"
    output: {both_ran: bool}

  # 11. for: + parallel: combination - Sequential iterations with parallel steps per iteration
  - name: for_with_parallel
    for: {i: "[1, 2]"}
    parallel:
      - name: sub_a
        bash: |
          echo "iteration={{ i }}"
          echo "task=a"
        output: {iteration: int, task: word}
      - name: sub_b
        bash: |
          echo "iteration={{ i }}"
          echo "task=b"
        output: {iteration: int, task: word}

  # 12. Verify for+parallel (should have 2 iterations, each with object results)
  - name: verify_for_parallel
    bash: |
      echo "iteration_count={{ for_with_parallel | length }}"
      echo "for_parallel_ok={{ for_with_parallel | length == 2 }}"
    output: {for_parallel_ok: bool}

  # 13. Summary step - Verify all parallel tests completed correctly
  - name: summary
    bash: |
      echo "all_tests_passed={{ verify_basic.both_present and verify_array.is_array and verify_lastof.has_value and verify_mixed.mixed_ok and verify_conditional.both_ran and verify_for_parallel.for_parallel_ok }}"
      echo "basic_parallel_ok={{ verify_basic.both_present }}"
      echo "array_join_ok={{ verify_array.is_array }}"
      echo "lastof_join_ok={{ verify_lastof.has_value }}"
      echo "mixed_types_ok={{ verify_mixed.mixed_ok }}"
      echo "conditional_ok={{ verify_conditional.both_ran }}"
      echo "for_parallel_ok={{ verify_for_parallel.for_parallel_ok }}"
    output: {all_tests_passed: bool}
