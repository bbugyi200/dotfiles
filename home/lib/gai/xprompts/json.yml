name: json
input:
  schema: text
steps:
  - name: setup
    hidden: true
    bash: gai_json_workflow --setup '{{ schema }}'
    output: { schema_json: text, semantic_hints: text }

  - name: inject
    prompt_part: |
      ---
      OUTPUT FORMAT REQUIREMENTS:

      Your response MUST be valid JSON that conforms to the following JSON Schema:

      ```json
      {{ setup.schema_json }}
      ```
      {% if setup.semantic_hints %}

      FIELD CONSTRAINTS:
      {{ setup.semantic_hints }}
      {% endif %}

      IMPORTANT:
      - Output ONLY the JSON data, wrapped in a code fence (```json ... ```)
      - Do NOT include any explanation or commentary before or after the JSON
      - The JSON must be valid and parseable
      - The JSON must conform exactly to the schema above

  - name: write_response
    hidden: true
    python: |
      import tempfile
      response = {{ _response | tojson }}
      with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
          f.write(response)
          print(f"response_file={f.name}")
    output: { response_file: path }

  - name: validate
    hidden: true
    bash: |
      gai_json_workflow --validate \
        --schema '{{ setup.schema_json }}' \
        --response-file '{{ write_response.response_file }}'
    output: { validated: word, data: text }
