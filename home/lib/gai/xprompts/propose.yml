input:
  - name: who
    type: line
    default: "man"
  - name: note
    type: line
    default: ""

steps:
  - name: inject
    prompt_part: |
      ---
      IMPORTANT: You should make the necessary file changes, but should NOT create/amend a CL. #cl

  - name: check_changes
    hidden: true
    bash: |
      changes=$(branch_local_changes)
      if [ -n "$changes" ]; then
        echo "has_changes=true"
      else
        echo "has_changes=false"
      fi
    output: { has_changes: bool }

  - name: save_response
    hidden: true
    if: "{{ check_changes.has_changes }}"
    python: |
      import tempfile
      import json
      prompt = {{ _prompt | tojson }}
      response = {{ _response | tojson }}
      with tempfile.NamedTemporaryFile(mode='w', suffix='.json', prefix='gai_propose_', delete=False) as f:
          json.dump({"prompt": prompt, "response": response}, f)
          print(f"data_file={f.name}")
    output: { data_file: path }

  - name: propose
    if: "{{ check_changes.has_changes }}"
    bash: |
      gai_propose_workflow --create \
        --who "{{ who }}" \
        --note "{{ note }}" \
        --data-file "{{ save_response.data_file }}" \
        --start-timestamp "{{ _start_timestamp | default('') }}"
    output: { success: bool, proposal_id: word, cl_name: word, diff_path: path, error: text }

  - name: report
    if: "{{ check_changes.has_changes }}"
    hidden: true
    bash: |
      echo "status=created"
      echo "message=Created proposal ({{ propose.proposal_id | default('') }}) on CL {{ propose.cl_name | default('') }}"
      echo "meta_proposal_id={{ propose.proposal_id | default('') }}"
      echo "diff_path={{ propose.diff_path | default('') }}"
    output: { status: word, message: text, meta_proposal_id: word, diff_path: path }
