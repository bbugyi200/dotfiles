name: split
# Workflow-level configuration for automatic resource management
config:
  claim_workspace: true
  create_artifacts: true
  log_workflow: true

input:
  - name: cl_name
    type: word
    default: "" # Empty means use current branch

steps:
  # Step 1: Setup - navigate to CL and gather metadata
  - name: setup
    bash: |
      gai_split_setup{% if cl_name %} --cl-name "{{ cl_name }}"{% endif %}
    output:
      type: json_schema
      schema:
        properties:
          cl_name:
            type: word
          diff_path:
            type: path
          bug:
            type: line
          workspace_name:
            type: word
          default_parent:
            type: word

  # Step 2: Generate split spec (agent with HITL)
  - name: generate_spec
    agent: split_spec_generator
    prompt: |
      #split_spec_generator(
        workspace_name="{{ setup.workspace_name }}",
        diff_path="{{ setup.diff_path }}"
      )
    output:
      type: json_schema
      schema:
        type: array
        items:
          type: object
          required:
            - name
            - description
          properties:
            name:
              type: word
            description:
              type: text
            parent:
              type: word
    hitl: true

  # Step 3: Format spec and navigate to parent
  - name: prepare_execute
    bash: |
      gai_split_prepare_execute --spec '{{ generate_spec | tojson }}' --cl-name "{{ setup.cl_name }}" --default-parent "{{ setup.default_parent }}"
    output:
      type: json_schema
      schema:
        properties:
          archive_path:
            type: path
          spec_markdown:
            type: text
          processing_order:
            type: text

  # Step 4: Execute split (agent)
  - name: execute_split
    agent: split_executor
    prompt: |
      #split_executor(
        diff_path="{{ setup.diff_path }}",
        spec_markdown="{{ prepare_execute.spec_markdown }}",
        default_parent="{{ setup.default_parent }}",
        bug_flag="{{ '-b ' + setup.bug if setup.bug else '' }}",
        note="Split from {{ setup.cl_name }} ({{ prepare_execute.archive_path }})",
        processing_order="{{ prepare_execute.processing_order }}"
      )

  # Step 5: Prompt to revert original CL (HITL)
  - name: revert_prompt
    bash: |
      echo "message=Revert the original CL '{{ setup.cl_name }}'?"
    output:
      type: json_schema
      schema:
        properties:
          message:
            type: text
    hitl: true

  # Step 6: Execute revert if approved
  - name: execute_revert
    python: |
      # revert_prompt.approved is set by HITL handler
      approved = {{ revert_prompt.approved | tojson }}
      if approved:
          from ace.changespec import find_all_changespecs
          from ace.revert import revert_changespec
          from rich.console import Console

          cs = next((c for c in find_all_changespecs() if c.name == "{{ setup.cl_name }}"), None)
          if cs:
              success, _ = revert_changespec(cs, Console())
              print("reverted=" + ("true" if success else "false"))
          else:
              print("reverted=false")
      else:
          print("reverted=skipped")
    output:
      type: json_schema
      schema:
        properties:
          reverted:
            type: word
