name: split
input: { split_desc: { type: line, default: "multiple CLs" } }
steps:
  # Step 1: Setup - gather metadata from current branch
  - name: setup
    bash: gai_split_setup
    output: { cl_name: word, diff_path: path, bug: line, workspace_name: word, default_parent: word }

  # Step 2: Generate split spec (agent with HITL)
  - name: generate_spec
    agent: |
      #split_spec_generator(
        workspace_name="{{ setup.workspace_name }}",
        diff_path="{{ setup.diff_path }}",
        split_desc="{{ split_desc }}"
      )
    output: [{ name: word, description: text, parent: { type: word, default: "" } }]
    hitl: true

  # Step 3: Format spec and navigate to parent
  - name: prepare_execute
    bash: |
      gai_split_prepare_execute --spec '{{ generate_spec | tojson }}' --cl-name "{{ setup.cl_name }}" --default-parent "{{ setup.default_parent }}"
    output: { archive_path: path, spec_markdown: text, processing_order: text }

  # Step 4: Execute split (agent)
  - name: execute_split
    agent: |
      #split_executor(
        diff_path="{{ setup.diff_path }}",
        spec_markdown="{{ prepare_execute.spec_markdown }}",
        default_parent="{{ setup.default_parent }}",
        bug_flag="{{ '-b ' + setup.bug if setup.bug else '' }}",
        note="Split from {{ setup.cl_name }} ({{ prepare_execute.archive_path }})",
        processing_order="{{ prepare_execute.processing_order }}"
      )

  # Step 5: Prompt to revert original CL (HITL)
  - name: revert_prompt
    bash: |
      echo "message=Revert the original CL '{{ setup.cl_name }}'?"
    output: { message: text }
    hitl: true

  # Step 6: Execute revert if approved
  - name: execute_revert
    python: |
      # revert_prompt.approved is set by HITL handler
      approved = {{ revert_prompt.approved | tojson }}
      if approved:
          from ace.changespec import find_all_changespecs
          from ace.revert import revert_changespec
          from rich.console import Console

          cs = next((c for c in find_all_changespecs() if c.name == "{{ setup.cl_name }}"), None)
          if cs:
              success, _ = revert_changespec(cs, Console())
              print("reverted=" + ("true" if success else "false"))
          else:
              print("reverted=false")
      else:
          print("reverted=skipped")
    output: { reverted: word }
