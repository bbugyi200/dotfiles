name: commit
input:
  - name: name
    type: word
  - name: bug_id
    type: int
    default: 0

steps:
  - name: inject
    prompt_part: |
      ---
      IMPORTANT: You should make the necessary file changes, but should NOT create/amend a CL.

  - name: check_changes
    hidden: true
    bash: |
      changes=$(branch_local_changes)
      if [ -n "$changes" ]; then
        echo "has_changes=true"
      else
        echo "has_changes=false"
      fi
    output: { has_changes: bool }

  - name: save_response
    hidden: true
    if: "{{ check_changes.has_changes }}"
    python: |
      import tempfile
      response = {{ _response | tojson }}
      with tempfile.NamedTemporaryFile(mode='w', suffix='.md', prefix='gai_commit_', delete=False) as f:
          f.write(response)
          print(f"response_file={f.name}")
    output: { response_file: path }

  - name: create_cl
    if: "{{ check_changes.has_changes }}"
    bash: |
      gai_commit_workflow --create \
        --name "{{ name }}" \
        --bug-id "{{ bug_id }}" \
        --response-file "{{ save_response.response_file }}"
    output: { success: bool, cl_url: line, full_cl_name: word, error: text }

  - name: report
    hidden: true
    bash: |
      if [ "{{ check_changes.has_changes }}" = "false" ]; then
        echo "status=no_changes"
        echo "message=No local changes detected - CL not created"
      elif [ "{{ create_cl.success | default(false) }}" = "true" ]; then
        echo "status=created"
        echo "message=Created CL {{ create_cl.full_cl_name | default('') }}: {{ create_cl.cl_url | default('') }}"
      else
        echo "status=error"
        echo "message={{ create_cl.error | default('Unknown error') }}"
      fi
    output: { status: word, message: text }
