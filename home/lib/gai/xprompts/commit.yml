input:
  - name: name
    type: word
  - name: bug_id
    type: int
    default: 0

steps:
  - name: inject
    prompt_part: |
      ---
      IMPORTANT: You should make the necessary file changes, but should NOT create/amend a CL.

  - name: check_changes
    hidden: true
    bash: |
      changes=$(branch_local_changes)
      if [ -n "$changes" ]; then
        echo "has_changes=true"
      else
        echo "has_changes=false"
      fi
    output: { has_changes: bool }

  - name: save_response
    hidden: true
    if: "{{ check_changes.has_changes }}"
    python: |
      import tempfile
      import json
      prompt = {{ _prompt | tojson }}
      response = {{ _response | tojson }}
      with tempfile.NamedTemporaryFile(mode='w', suffix='.json', prefix='gai_commit_', delete=False) as f:
          json.dump({"prompt": prompt, "response": response}, f)
          print(f"data_file={f.name}")
    output: { data_file: path }

  - name: check_make_cl_desc
    hidden: true
    if: "{{ check_changes.has_changes }}"
    python: |
      import sys, os
      sys.path.insert(0, os.path.join(os.path.expanduser('~'), 'lib', 'gai', 'src'))
      try:
          from xprompt.loader import get_all_xprompts
          has = 'make_cl_desc' in get_all_xprompts()
      except Exception:
          has = False
      print(f"has_make_cl_desc={'true' if has else 'false'}")
    output: { has_make_cl_desc: bool }

  - name: gen_cl_desc
    if: "{{ check_changes.has_changes and check_make_cl_desc.has_make_cl_desc }}"
    prompt: "#make_cl_desc #file:new_cl_desc"
    output: { desc_file: path }

  - name: commit
    if: "{{ check_changes.has_changes }}"
    bash: |
      gai_commit_workflow --create \
        --name "{{ name }}" \
        --bug-id "{{ bug_id }}" \
        --data-file "{{ save_response.data_file }}" \
        --generated-desc-file "{{ gen_cl_desc.desc_file | default('') }}"
    output: { success: bool, cl_url: line, full_cl_name: word, diff_path: path, error: text }

  - name: report
    if: "{{ check_changes.has_changes }}"
    hidden: true
    bash: |
      echo "status=created"
      echo "message=Created CL {{ commit.full_cl_name | default('') }}: {{ commit.cl_url | default('') }}"
      echo "meta_new_cl={{ commit.full_cl_name | default('') }} ({{ commit.cl_url | default('') }})"
      echo "diff_path={{ commit.diff_path | default('') }}"
    output: { status: word, message: text, meta_new_cl: line, diff_path: path }
