#!/bin/bash

set -e

should_upload=true
if [[ "$1" == "-U" || "$1" == "--no-upload" ]]; then
  should_upload=false
  shift
fi

set -x
# Prevents content divergence errors (ex: if another agents amended this CL in another workspace).
hg update $(branch_name)
# Add new/removed files to the commit.
hg addremove
# Amend the last commit with the staged changes.
hg amend -n "$@"
set +x

if $should_upload; then
  set -x
  bb_hg_upload
  set +x
fi
