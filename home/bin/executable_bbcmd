#!/bin/bash

export TZ=America/New_York

if [ $# -lt 2 ]; then
  echo "Usage: bbcmd <command> <subcommand> [args...]" >&2
  exit 1
fi

cmd="$1"
subcmd="$2"
shift 2

if command -v branch_name &>/dev/null; then
  branch=$(branch_name)
else
  branch=default
fi
log_dir="bb/bbcmd/$cmd/$subcmd/$branch"
timestamp=$(date "+%Y%m%d_%H%M%S")
log_file="$log_dir/$timestamp.txt"
patch_file="$log_dir/$timestamp.patch"

mkdir -p "$log_dir"

full_command="$cmd $subcmd $*"

echo "$full_command"

if command -v branch_number &>/dev/null; then
  branch_num=$(branch_number)
  cl_link="cl/$branch_num"
else
  cl_link="N/A"
fi

start_time=$(date +%s)

{
  echo "Command: $full_command"
  echo "Date: $(date)"
  echo "Branch: $branch"
  echo "CL Link: $cl_link"
  echo "----------------------------------------"
} >"$log_file"

exec > >(tee -a "$log_file") 2>&1

"$cmd" "$subcmd" "$@"
exit_code=$?

end_time=$(date +%s)
runtime=$((end_time - start_time))

echo "----------------------------------------" >>"$log_file"
echo "Runtime: ${runtime}s" >>"$log_file"

branch_diff >"$patch_file" 2>/dev/null || echo "No branch diff available" >"$patch_file"

bam 2>/dev/null

exit $exit_code
