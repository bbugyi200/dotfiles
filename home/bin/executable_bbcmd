#!/bin/bash

set -euo pipefail

if [ $# -lt 2 ]; then
  echo "Usage: bbcmd <command> <subcommand> [args...]" >&2
  exit 1
fi

cmd="$1"
subcmd="$2"
shift 2

if command -v branch_name &>/dev/null; then
  branch=$(branch_name)
else
  branch=default
fi
log_dir="bb/bbcmd/$cmd/$subcmd"
log_file="$log_dir/$branch.txt"

mkdir -p "$log_dir"

full_command="$cmd $subcmd $*"

echo "$full_command"

{
  echo "Command: $full_command"
  echo "Date: $(date)"
  echo "Branch: $branch"
  echo "----------------------------------------"
} >"$log_file"

exec > >(tee -a "$log_file") 2>&1

"$cmd" "$subcmd" "$@"
exit_code=$?

bam 2>/dev/null

exit $exit_code
