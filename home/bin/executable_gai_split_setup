#!/usr/bin/env python3
"""Setup step for the gai split workflow."""

import argparse
import os
import subprocess
import sys
from pathlib import Path

# Add gai source directory to path for imports
_GAI_SRC = Path.home() / "lib" / "gai" / "src"
if str(_GAI_SRC) not in sys.path:
    sys.path.insert(0, str(_GAI_SRC))


def _parse_args() -> argparse.Namespace:
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description="Setup step for the gai split workflow"
    )
    parser.add_argument(
        "--cl-name",
        dest="cl_name",
        default="",
        help="CL name to split (defaults to current branch)",
    )
    return parser.parse_args()


def main() -> None:
    """Run the setup step for split workflow."""
    from ace.changespec import find_all_changespecs

    args = _parse_args()
    cl_name = args.cl_name

    if not cl_name:
        cl_name = subprocess.run(
            ["branch_name"], capture_output=True, text=True, check=True
        ).stdout.strip()

    # Validate no children
    cs_list = find_all_changespecs()
    children = [
        cs for cs in cs_list if cs.parent == cl_name and cs.status != "Reverted"
    ]
    if children:
        print("error=Cannot split: CL has child CLs")
        sys.exit(1)

    # Get default parent
    target = next((cs for cs in cs_list if cs.name == cl_name), None)
    default_parent = target.parent if target and target.parent else "p4head"

    # Navigate and save diff
    subprocess.run(["bb_hg_clean", f"{cl_name}-split-nav"], check=True)
    subprocess.run(["bb_hg_update", cl_name], check=True)
    os.makedirs("bb/gai", exist_ok=True)
    diff_path = f"bb/gai/{cl_name}.diff"
    with open(diff_path, "w") as f:
        result = subprocess.run(
            ["branch_diff"], capture_output=True, text=True, check=True
        )
        f.write(result.stdout)

    bug = subprocess.run(
        ["branch_bug"], capture_output=True, text=True, check=True
    ).stdout.strip()
    workspace = subprocess.run(
        ["workspace_name"], capture_output=True, text=True, check=True
    ).stdout.strip()

    print(f"cl_name={cl_name}")
    print(f"diff_path={diff_path}")
    print(f"bug={bug}")
    print(f"workspace_name={workspace}")
    print(f"default_parent={default_parent}")


if __name__ == "__main__":
    main()
