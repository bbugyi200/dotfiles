#!/bin/bash

# Get all window names in the current session
existing_windows=$(tmux list-windows -F '#W')

# Check if any window is an ai variant (ai, ai2, ai3, etc.)
if ! echo "$existing_windows" | grep -qE "^ai[0-9]*$"; then
    # No ai windows exist, create 'ai'
    window_name="ai"
else
    # At least one ai window exists, find next available number
    n=2
    while echo "$existing_windows" | grep -q "^ai${n}$"; do
        ((n++))
    done
    window_name="ai${n}"
fi

# Create a unique channel for this window's cleanup signal
channel="ai-cleanup-$$"

# Run waiter in tmux's background (-b flag)
# This keeps the process alive as a tmux-managed job, avoiding orphaning issues
tmux run-shell -b "tmux wait-for '$channel' && sleep 0.1 && tm-fix-layout && tm-renumber-ai-windows"

# Create window - when claude exits, signal the channel before window closes
tmux new-window -n "$window_name" "cd ~/.local/share/chezmoi && claude --dangerously-skip-permissions; tmux wait-for -S '$channel'"
