#!/bin/bash

run() {
  if [[ $# -ne 2 ]]; then
    echo "Usage: $(basename "$0") <project> <N>"
    return 2
  fi

  local project="$1"
  shift

  local N="$1"
  shift

  # Determine VCS provider: env var > auto-detect > GOOG_CLOUD_DIR fallback > default git
  local vcs="${GAI_VCS_PROVIDER:-}"
  if [[ -z "$vcs" ]]; then
    local root="${GAI_WORKSPACE_ROOT:-${HOME}/workspace}"
    local primary_dir="$root/$project"
    if [[ -d "$primary_dir/.hg" ]]; then
      vcs="hg"
    elif [[ -d "$primary_dir/.git" ]]; then
      vcs="git"
    elif [[ -n "${GOOG_CLOUD_DIR:-}" ]]; then
      vcs="hg"
    else
      vcs="git"
    fi
  fi

  if [[ "$vcs" == "hg" ]]; then
    exec bb_get_workspace "$project" "$N"
  fi

  # --- git mode ---
  local root="${GAI_WORKSPACE_ROOT:-${HOME}/workspace}"
  local primary_dir="$root/$project"

  if ! [[ -d "$primary_dir" ]]; then
    echo "[ERROR] Primary workspace does not exist: $primary_dir" >&2
    return 1
  fi

  if [[ "$N" == "1" ]]; then
    echo "$primary_dir"
  else
    local worktree_dir="$root/${project}_${N}"
    if ! [[ -d "$worktree_dir" ]]; then
      if ! git -C "$primary_dir" worktree add --detach "$worktree_dir" 1>&2; then
        echo "[ERROR] Failed to create git worktree: $worktree_dir" >&2
        return 1
      fi
    fi
    echo "$worktree_dir"
  fi
}

run "$@"
