#!/bin/bash
# Check if a presubmit has completed for a ChangeSpec
#
# Exit codes:
#   0 - Presubmit completed successfully
#   1 - Presubmit completed with failure
#   2 - Presubmit is still running
#   3 - Error (e.g., ChangeSpec not found, no presubmit file)

set -euo pipefail

CHANGESPEC_NAME="${1:-}"

if [[ -z "$CHANGESPEC_NAME" ]]; then
    echo "Usage: is_presubmit_complete <changespec_name>" >&2
    exit 3
fi

# Find the project file containing this ChangeSpec
GAI_PROJECTS_DIR="${HOME}/.gai/projects"

if [[ ! -d "$GAI_PROJECTS_DIR" ]]; then
    echo "GAI projects directory not found: $GAI_PROJECTS_DIR" >&2
    exit 3
fi

# Search for the ChangeSpec in all project files
PRESUBMIT_FILE=""

for project_dir in "$GAI_PROJECTS_DIR"/*/; do
    if [[ ! -d "$project_dir" ]]; then
        continue
    fi

    project_name=$(basename "$project_dir")
    project_file="${project_dir}${project_name}.gp"

    if [[ ! -f "$project_file" ]]; then
        continue
    fi

    # Check if this file contains the ChangeSpec
    if grep -q "^NAME: ${CHANGESPEC_NAME}$" "$project_file"; then
        # Extract PRESUBMIT from the ChangeSpec
        in_changespec=false
        while IFS= read -r line; do
            if [[ "$line" == "NAME: ${CHANGESPEC_NAME}" ]]; then
                in_changespec=true
                continue
            fi

            if $in_changespec; then
                # Check if we've hit the next NAME: field (new ChangeSpec)
                if [[ "$line" =~ ^NAME:\ .+ ]]; then
                    break
                fi

                # Extract PRESUBMIT field
                if [[ "$line" =~ ^PRESUBMIT:\ (.+)$ ]]; then
                    PRESUBMIT_FILE="${BASH_REMATCH[1]}"
                    # Expand ~ to home directory
                    PRESUBMIT_FILE="${PRESUBMIT_FILE/#\~/$HOME}"
                fi
            fi
        done < "$project_file"

        break
    fi
done

# Check if we found the presubmit file
if [[ -z "$PRESUBMIT_FILE" ]]; then
    echo "No presubmit file found for ChangeSpec: $CHANGESPEC_NAME" >&2
    exit 3
fi

if [[ ! -f "$PRESUBMIT_FILE" ]]; then
    echo "Presubmit file does not exist: $PRESUBMIT_FILE" >&2
    exit 3
fi

# Check if the file contains the completion marker
# Magic marker format: ===PRESUBMIT_COMPLETE=== EXIT_CODE: <code>
LAST_LINE=$(tail -n 1 "$PRESUBMIT_FILE")

if [[ "$LAST_LINE" =~ ===PRESUBMIT_COMPLETE===\ EXIT_CODE:\ ([0-9]+) ]]; then
    # Presubmit has completed - extract and return the exit code
    PRESUBMIT_EXIT_CODE="${BASH_REMATCH[1]}"
    
    if [[ "$PRESUBMIT_EXIT_CODE" -eq 0 ]]; then
        # Success
        exit 0
    else
        # Failure
        exit 1
    fi
fi

# No completion marker found - presubmit is still running
exit 2
