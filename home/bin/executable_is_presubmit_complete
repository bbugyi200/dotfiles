#!/bin/bash
# Check if a presubmit has completed for a ChangeSpec
#
# Exit codes:
#   0 - Presubmit completed successfully
#   1 - Presubmit completed with failure
#   2 - Presubmit is still running
#   3 - Error (e.g., ChangeSpec not found, no presubmit file)

set -euo pipefail

CHANGESPEC_NAME="${1:-}"

if [[ -z "$CHANGESPEC_NAME" ]]; then
    echo "Usage: is_presubmit_complete <changespec_name>" >&2
    exit 3
fi

# Find the project file containing this ChangeSpec
GAI_PROJECTS_DIR="${HOME}/.gai/projects"

if [[ ! -d "$GAI_PROJECTS_DIR" ]]; then
    echo "GAI projects directory not found: $GAI_PROJECTS_DIR" >&2
    exit 3
fi

# Search for the ChangeSpec in all project files
PRESUBMIT_FILE=""

for project_dir in "$GAI_PROJECTS_DIR"/*/; do
    if [[ ! -d "$project_dir" ]]; then
        continue
    fi

    project_name=$(basename "$project_dir")
    project_file="${project_dir}${project_name}.gp"

    if [[ ! -f "$project_file" ]]; then
        continue
    fi

    # Check if this file contains the ChangeSpec
    if grep -q "^NAME: ${CHANGESPEC_NAME}$" "$project_file"; then
        # Extract PRESUBMIT from the ChangeSpec
        in_changespec=false
        while IFS= read -r line; do
            if [[ "$line" == "NAME: ${CHANGESPEC_NAME}" ]]; then
                in_changespec=true
                continue
            fi

            if $in_changespec; then
                # Check if we've hit the next NAME: field (new ChangeSpec)
                if [[ "$line" =~ ^NAME:\ .+ ]]; then
                    break
                fi

                # Extract PRESUBMIT (new field name)
                if [[ "$line" =~ ^PRESUBMIT:\ (.+)$ ]]; then
                    PRESUBMIT_FILE="${BASH_REMATCH[1]}"
                    # Expand ~ to home directory
                    PRESUBMIT_FILE="${PRESUBMIT_FILE/#\~/$HOME}"
                fi
            fi
        done < "$project_file"

        break
    fi
done

# Check if we found the presubmit file
if [[ -z "$PRESUBMIT_FILE" ]]; then
    echo "No presubmit file found for ChangeSpec: $CHANGESPEC_NAME" >&2
    exit 3
fi

if [[ ! -f "$PRESUBMIT_FILE" ]]; then
    echo "Presubmit file does not exist: $PRESUBMIT_FILE" >&2
    exit 3
fi

# Read PID from first line of presubmit file
FIRST_LINE=$(head -n 1 "$PRESUBMIT_FILE")
if [[ ! "$FIRST_LINE" =~ ^PID:\ ([0-9]+)$ ]]; then
    echo "No PID found in presubmit file: $PRESUBMIT_FILE" >&2
    exit 3
fi

PRESUBMIT_PID="${BASH_REMATCH[1]}"

# Check if the process is still running
if kill -0 "$PRESUBMIT_PID" 2>/dev/null; then
    # Process is still running
    exit 2
fi

# Process has completed - check the output file for success/failure
# Skip the first line (PID) when checking for patterns
CONTENT=$(tail -n +2 "$PRESUBMIT_FILE")

# Check for failure patterns first
if echo "$CONTENT" | grep -qiE "(FAILED|ERROR|FAILURE|BUILD BROKEN)"; then
    # Found failure indicators
    exit 1
fi

# Check for success patterns
if echo "$CONTENT" | grep -qiE "(SUCCESS|PASSED|ALL TESTS PASSED|PRESUBMIT.*COMPLETE)"; then
    # Found success indicators
    exit 0
fi

# If the file exists and process completed but no clear success/failure,
# check if the file ends with a common completion marker
# Default to success if process completed normally (no error patterns found)
exit 0
