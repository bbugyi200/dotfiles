#!/bin/bash

source ~/lib/bugyi.sh

export USAGE_GRAMMAR=(
  "[-v] [CL_DESCRIPTION]"
  "[-v] -t TAG_NAME TAG_VALUE"
  "-h"
)

read -r -d '' DOC <<EOM
$(usage)

Reword the current CL, then evolve and upload.

If CL_DESCRIPTION is provided, it is passed directly to 'hg reword -m'
using ANSI-C quoting (the caller must pre-escape the string).

If neither CL_DESCRIPTION nor -t is given, 'hg reword' opens an editor.

Positional Arguments
--------------------
CL_DESCRIPTION
    Optional pre-escaped CL description string. Mutually exclusive with -t.

Optional Arguments
------------------
-h | --help
    View this help message.

-t TAG_NAME | --add-tag TAG_NAME
    Append TAG_NAME=TAG_VALUE to the current CL description. TAG_NAME is
    uppercased automatically. Requires exactly one positional argument
    (TAG_VALUE) after all options. Mutually exclusive with CL_DESCRIPTION
    used as a full reword string.

-v | --verbose
    Enable verbose output. This option can be specified multiple times (e.g. -v, -vv, ...).

Examples
--------
bb_hg_reword                           # Open editor to reword
bb_hg_reword 'new description'         # Reword with pre-escaped description
bb_hg_reword -t bug 12345             # Append BUG=12345 to current description
bb_hg_reword --add-tag markdown true   # Append MARKDOWN=true to current description
EOM

set -e

function run() {
  parse_cli_args "$@"

  if [[ -n "${TAG_NAME}" ]]; then
    local current_desc
    current_desc="$(cl_desc)"
    local upper_tag
    upper_tag="$(echo "${TAG_NAME}" | tr '[:lower:]' '[:upper:]')"
    local new_desc="${current_desc}"$'\n'"${upper_tag}=${TAG_VALUE}"
    log::debug "New description:\n%s" "${new_desc}"
    hg reword -m "${new_desc}"
  elif [[ -n "${CL_DESCRIPTION}" ]]; then
    bash -c "hg reword -m \$'${CL_DESCRIPTION}'"
  else
    hg reword
  fi

  # hg evolve --any may fail if there are no orphan changesets to evolve.
  set +e
  hg evolve --any
  set -e

  hg upload tree
}

function parse_cli_args() {
  log::debug "Command-Line Arguments: ($*)"

  eval set -- "$(getopt -o "h,t:,v" -l "help,add-tag:,verbose" -- "$@")"

  VERBOSE=0
  TAG_NAME=""
  while [[ -n "$1" ]]; do
    case $1 in
    -h | --help)
      echo "${DOC}"
      exit 0
      ;;
    -t | --add-tag)
      shift
      TAG_NAME="$1"
      ;;
    -v | --verbose)
      VERBOSE=$((VERBOSE + 1))
      ;;
    --)
      shift
      break
      ;;
    esac
    shift
  done

  if [[ "${VERBOSE}" -gt 1 ]]; then
    PS4='$LINENO: '
    set -x
  fi

  if [[ -n "${TAG_NAME}" ]]; then
    if [[ $# -ne 1 ]]; then
      die -x2 "$(usage)\n\n--add-tag requires exactly one positional argument (TAG_VALUE), got $#."
    fi
    TAG_VALUE="$1"
    CL_DESCRIPTION=""
  else
    if [[ $# -gt 1 ]]; then
      die -x2 "$(usage)\n\nExpected at most 1 positional argument (CL_DESCRIPTION), got $#."
    fi
    CL_DESCRIPTION="${1:-}"
    TAG_VALUE=""
  fi

  readonly CL_DESCRIPTION
  readonly DOC
  readonly TAG_NAME
  readonly TAG_VALUE
  readonly VERBOSE
}

if [[ "${SCRIPTNAME}" == "$(basename "${BASH_SOURCE[0]}")" ]]; then
  run "$@"
fi
