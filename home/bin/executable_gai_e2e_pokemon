#!/bin/bash

# Function to pause and wait for user confirmation.
pause_for_user() {
    local msg="$1"
    shift

    echo ""
    echo ">>> NEXT: ${msg}"
    read -rp "Press Enter to continue or Ctrl+C to abort..."
}

# Wrapper to run `gai run` with set -x for debugging.
gai_run() {
    set -x
    gai run "$@"
    set +x
}

# Main function to execute the e2e test for Pokemon functionality.
run() {
    gai_run -c pokemon "Implement full functionality for the new AdUnit Pokemon dropdown field" \
        "Can you help me implement the full functionality (including tests) for the project described in the @~/bb/designs/foobar_pokemon.md design document? Make ALL of the necessary file changes, but do NOT attempt to create a CL."

    local expected_cl_name="$(workspace_name)_pokemon"
    if [[ "$(branch_name)" != "${expected_cl_name}" ]]; then
        echo "[ERROR] The '${expected_cl_name}' CL was NOT created." >&2
        exit 1
    fi

    local first_chat="$(gai run -l | grep -- -run- | head -n 1)"
    pause_for_user "Run functional completeness verification"
    gai_run -r "${first_chat}" \
        "Can you verify that the changes made by the previous agent are functionally complete? If anything is missing, please add it now. Make ALL of the necessary file changes, but do NOT attempt to amend/upload the CL.\n\nx::this_cl"

    pause_for_user "Run sound verification (testing)"
    gai_run -r "${first_chat}" \
        "Can you verify that the changes made by the previous agent have been tested properly? Do not add any new test files unless they are intended to flex new code files that were added by this CL. Any existing test files that flex the code files changed by this CL should properly flex the new/modified functionality this CL introduces. If any changes need to be made, please make them now. Make ALL of the necessary file changes, but do NOT attempt to amend/upload the CL.\n\nx::this_cl"

    pause_for_user "Split this CL into multiple CLs"
    gai_run split -y
}

run "$@"
