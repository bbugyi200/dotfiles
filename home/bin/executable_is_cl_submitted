#!/bin/bash

if [[ -z "$1" ]]; then
  echo "Usage: $0 <cl_name>"
  exit 1
fi

cl_name="$1"
shift
cl_number="$(hg xl | grep "$cl_name" | grep "exported as" | perl -nE "\$_ =~ s{.*/cl/(\d+).*}{\$1}g; print \$_ if /\$_/")"
if [[ -z "${cl_number}" ]]; then
  echo "Could not find CL number for name: ${cl_name}"
  exit 1
fi

# Fetch the status of the CL.
# The -F'%status%' flag formats the output to only show the status field.
status=$(stubby call blade:codereview-rpc CodereviewRpcService.GetChangelistSummary "changelist_number: $cl_number" | grep '^status:' | cut -d' ' -f2)

if [[ "$status" == "SUBMITTED" ]]; then
  echo "http://cl/${cl_number} is submitted."
  exit 0
elif [[ -z "$status" ]]; then
  echo "Unable to parse status for http://cl/${cl_number}."
  exit 1
else
  echo "http://cl/${cl_number} is NOT submitted (status=${status})."
  exit 1
fi
