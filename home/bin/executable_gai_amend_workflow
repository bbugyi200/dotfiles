#!/usr/bin/env python3
"""Helper script for the #amend xprompt workflow.

Amends an existing CL after agent file changes, adding a HISTORY entry.
"""

import argparse
import json
import os
import subprocess
import sys
import tempfile
from pathlib import Path

# Add gai source directory to path for imports
_GAI_SRC = Path.home() / "lib" / "gai" / "src"
if str(_GAI_SRC) not in sys.path:
    sys.path.insert(0, str(_GAI_SRC))


def _get_project_from_workspace() -> str | None:
    """Get the project name from the current workspace."""
    result = subprocess.run(
        ["workspace_name"], capture_output=True, text=True, check=False
    )
    if result.returncode != 0:
        return None
    return result.stdout.strip() or None


def _get_cl_name_from_branch() -> str | None:
    """Get the CL name from the current branch."""
    result = subprocess.run(
        ["branch_name"], capture_output=True, text=True, check=False
    )
    if result.returncode != 0:
        return None
    branch = result.stdout.strip()
    return branch if branch else None


def _amend_cl(
    note: str,
    data_file: str,
) -> tuple[bool, str, str, str]:
    """Amend the current CL with a HISTORY entry.

    Args:
        note: The note for the HISTORY entry (empty string to auto-generate).
        data_file: Path to JSON file containing prompt and response from agent.

    Returns:
        Tuple of (success, entry_id, cl_name, error_message)
    """
    from chat_history import save_chat_history
    from commit_utils import add_commit_entry, save_diff
    from gai_utils import generate_timestamp
    from summarize_utils import get_file_summary
    from workflow_utils import add_test_hooks_if_available, get_project_file_path

    # Load prompt and response from data file
    with open(data_file, "r", encoding="utf-8") as f:
        data = json.load(f)
    prompt = data["prompt"]
    response = data["response"]

    # Get CL name from branch
    cl_name = _get_cl_name_from_branch()
    if not cl_name:
        return False, "", "", "Could not determine CL name from branch"

    # Get project name
    project = _get_project_from_workspace()
    if not project:
        return False, "", "", "Could not determine project from workspace"

    # Get project file path
    project_file = get_project_file_path(project)
    if not os.path.exists(project_file):
        return False, "", "", f"Project file not found: {project_file}"

    # Generate timestamp for consistent filenames
    timestamp = generate_timestamp()

    # Save the current diff before amending
    diff_path = save_diff(cl_name, target_dir=None, timestamp=timestamp)
    if not diff_path:
        return False, "", "", "No changes to amend (diff is empty)"

    # Generate note from response if not provided
    if not note:
        # Write response to temp file for get_file_summary
        fd, response_tmp = tempfile.mkstemp(suffix=".md", prefix="gai_amend_response_")
        try:
            with os.fdopen(fd, "w", encoding="utf-8") as f:
                f.write(response)
            note = get_file_summary(
                response_tmp,
                usage="a concise description of the changes made",
                fallback="Agent changes",
            )
        finally:
            try:
                os.unlink(response_tmp)
            except OSError:
                pass

    # Save chat history with actual prompt
    chat_path = save_chat_history(
        prompt=prompt,
        response=response,
        workflow="amend",
        timestamp=timestamp,
    )

    # Run bb_hg_amend
    try:
        result = subprocess.run(
            ["bb_hg_amend", note],
            capture_output=True,
            text=True,
            check=False,
        )
        if result.returncode != 0:
            return False, "", "", f"bb_hg_amend failed: {result.stderr}"
    except FileNotFoundError:
        return False, "", "", "bb_hg_amend command not found"

    # Add HISTORY entry
    success = add_commit_entry(
        project_file=project_file,
        cl_name=cl_name,
        note=note,
        diff_path=diff_path,
        chat_path=chat_path,
        end_timestamp=timestamp,
    )

    if not success:
        return False, "", "", f"Failed to add HISTORY entry for {cl_name}"

    # Add test hooks if available
    add_test_hooks_if_available(project_file, cl_name)

    # Get the entry ID (next commit number - 1 since we just added it)
    from commit_utils.entries import get_next_commit_number

    with open(project_file, encoding="utf-8") as f:
        lines = f.readlines()
    entry_id = str(get_next_commit_number(lines, cl_name) - 1)

    return True, entry_id, cl_name, ""


def main() -> None:
    """Main entry point."""
    parser = argparse.ArgumentParser(
        description="Helper for the #amend xprompt workflow"
    )
    parser.add_argument(
        "--note", default="", help="Note for the HISTORY entry (auto-generated if empty)"
    )
    parser.add_argument(
        "--data-file", required=True, help="Path to JSON file with prompt and response"
    )

    args = parser.parse_args()

    success, entry_id, cl_name, error = _amend_cl(args.note, args.data_file)
    print(f"success={'true' if success else 'false'}")
    print(f"entry_id={entry_id}")
    print(f"cl_name={cl_name}")
    print(f"error={error}")


if __name__ == "__main__":
    main()
