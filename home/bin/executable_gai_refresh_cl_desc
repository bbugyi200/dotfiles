#!/usr/bin/env python3
"""Reword step for the gai refresh_cl_desc workflow."""

import re
import subprocess
import sys


def escape_for_hg_reword(desc: str) -> str:
    """Escape a description string for passing to bb_hg_reword."""
    return (
        desc.replace("\\", "\\\\")
        .replace("'", "\\'")
        .replace("\n", "\\n")
        .replace("\t", "\\t")
        .replace("\r", "\\r")
    )


def main() -> None:
    """Run the reword step for refresh_cl_desc workflow."""
    desc_file = sys.argv[1]

    # Read AI-generated description
    with open(desc_file) as f:
        new_desc = f.read().strip()

    # Get current full description to preserve metadata tags
    result = subprocess.run(
        ["cl_desc"], capture_output=True, text=True, check=True
    )
    current_full = result.stdout.rstrip("\n")

    # Extract project prefix (e.g., "yserve" from "[yserve] ...")
    project_match = re.match(r"^\[([^\]]+)\]", current_full)
    project = project_match.group(1) if project_match else None

    # Extract metadata tag block from end of current description
    lines = current_full.split("\n")
    tag_pattern = re.compile(r"^[A-Z][A-Za-z_\s-]*[=:]")

    # Skip trailing blank lines
    last_non_blank = len(lines) - 1
    while last_non_blank >= 0 and lines[last_non_blank].strip() == "":
        last_non_blank -= 1

    # Scan upward to find contiguous tag block
    tags_start = len(lines)
    for i in range(last_non_blank, -1, -1):
        if tag_pattern.match(lines[i].strip()):
            tags_start = i
        else:
            break

    tag_block = (
        "\n".join(lines[tags_start:]) if tags_start < len(lines) else ""
    )

    # Prepend project prefix
    if project:
        new_desc = f"[{project}] {new_desc}"

    # Combine new description with original metadata tags
    full_desc = (
        (new_desc + "\n\n<!-- prettier-ignore -->\n" + tag_block)
        if tag_block
        else new_desc
    )

    escaped = escape_for_hg_reword(full_desc)
    subprocess.run(["bb_hg_reword", escaped], check=True)
    print("success=true")


if __name__ == "__main__":
    main()
