#!/bin/bash

me_mode=false

# Parse --me option
while [[ "$1" == --* ]]; do
  case "$1" in
    --me)
      me_mode=true
      shift
      ;;
    *)
      break
      ;;
  esac
done

if [[ -n "$1" ]]; then
  cl_number="$(branch_num_from_name "$1")"
  shift
else
  cl_number="$(branch_number)"
fi

if [[ "$me_mode" == true ]]; then
  # Me mode: include ALL unresolved comments if ANY comment contains "#me"
  # Exclude comments where the last reply contains "#no"
  stubby call blade:codereview-rpc CodereviewRpcService.GetComments \
    --proto2 "changelist_number: ${cl_number}" --output_json |
    jq "$@" '
      .comment as $comments |
      if ($comments | any(.content | test("#me"))) then
        $comments
        | sort_by(.depot_path, .line_number)[]
        | select(.resolved != true)
        | select((.reply | length == 0) or (.reply[-1].content | test("#no") | not))
        | .content |= (gsub("#me "; "") | gsub(" #me"; "") | gsub("#me"; ""))
      else
        empty
      end'
else
  stubby call blade:codereview-rpc CodereviewRpcService.GetComments \
    --proto2 "changelist_number: ${cl_number}" --output_json |
    jq "$@" '.comment
           | sort_by(.depot_path, .line_number)[]
           | select(.resolved != true
                    and .author!="startblock"
                    and .author!="gwsq"
                    and (.author!="bbugyi" or (.reply[] | length > 0))
                    and .reply[-1].author != "bbugyi")'
fi
