# Snippets are reusable text templates that can be referenced in prompts.
# Usage: #snippet_name or #snippet_name(arg1, arg2)
# Placeholders: {1}, {2} for positional args, {1:default} for optional
snippets:
  b: "Can you help me fix the bug described by the #bug:{1} file? #noc"
  b_ab: |
    #b:{1} Refer to the 'How to add a Authorized Buyers' section of the @contentads/drx/fe/g3doc/indirect/bidders.md
    file to help you with this. #clref:852317975
  bug: "#(bug_desc: bugged show '{1}')"
  chat: "@$(gai_first_commit_chat)"
  cl: |
    ### Context Files Related to this CL
    + #(cl_changes.diff: hg pdiff $(branch_changes | grep -v -E 'png$|fingerprint$') | perl -nE 'print s{google3/}{}gr'): Contains a diff of the changes made by the current CL.
    + #(cl_desc: cl_desc --short): Contains the current CL's change description.
    {%- if _1|default(false) %}
    + #chat: Contains the initial conversation with Gemini that resulted in the creation of this CL.
    {%- endif %}
  clr: "cl/{1} (see the #(cl_desc_and_diff: p4 diff -c '{1}') file)"
  clref: "Use #clr:{1} as a reference."
  duck: "See the agent chat in @$(printf '%s\\n' ~/bb/duckie/* | sort | tail -n 1) for some initial ideas."
  feat: |
    publisher feature (see @contentads/drx/fe/g3doc/admin/publisher_features.md for more information on publisher features)
  newfeat: |
    Can you help me add a new #feat named {1} to the java/com/google/ads/publisher/domain/entity/feature/publisher_features.textproto file?
    This publisher feature will be used to {2}. #noc
  noc: "You should make the necessary file changes, but should NOT create/amend a CL."
  nocl: "#noc #cl"
  scuba: "Make sure all related tests pass, except for some scuba diff tests, which are expected to fail."

# Metahooks intercept failing hooks before the summarize agent runs.
metahooks:
  - name: scuba
    hook_command: bb_rabbit_test
    output_regex: "Expected: Scuba Result PASSED"
  - name: hg_presubmit_tap
    hook_command: bb_hg_presubmit
    output_regex: "[1-9]\\d* failed,"

# Mentor profiles define which mentors to apply to which files.
# Each profile contains its mentor definitions inline.
mentor_profiles:
  - profile_name: aaa
    mentors:
      - mentor_name: aaa
        prompt: |
          Can you help me enforce the AAA (arrange, act, assert) test method structure? In particular, find and fix Any test
          method modified by this CL that does NOT structure its statements using the Arrange, Act, Assert pattern. There
          should NEVER be a blank line that breaks up one of these sections. Use comments if necessary to separate different
          parts of each section, but NEVER specify the section name using a comment (ex: '# Act'). When no section has more
          than 1 top-level (ex: not nested in a lambda expression block) statement, no blank lines are necessary. Otherwise,
          the sections should ALWAYS be separated by a blank line.
    file_globs:
      - "javatests/**/*.java"
      - "**/test*.dart"
  - profile_name: code
    mentors:
      - mentor_name: comments
        prompt: |
          Can you help me ensure that all code changes in this CL follow best practices for code comments? Specifically,
          ensure that:
            + All public fields, functions, classes, and methods have clear and concise doc comments that follow best
              practices for the language they are written in. EXCEPTIONS:
                - Getters and setters do not need doc comments unless they have non-trivial logic.
                - If the best you can do is restate the name of the field, function, class, or method in the comment, then
                  no comment is necessary.
            + We are critical about the comments we add â€” avoid redundant comments that simply restate what the code does.
      - mentor_name: shared_code
        prompt: |
          Can you help me identify any code that is duplicated across multiple files in this CL? You should use your
          CodeSearch tool to search for duplication and/or existing shared utilities across the codebase (related to the
          changes made in this CL). If you find any, please refactor the code to factor out a new shared utility / use the
          existing shared utility.
      - mentor_name: sound_tests
        run_on_wip: true
        prompt: |
          Can you help me ensure that the changes made in this CL have proper test coverage? Specifically, you should
          verify that:
            + New logic comes with new or strengthened tests (or a clear justification for why existing tests are
              sufficient).
            + in the case of bug fixes, regressions are actively guarded against, not "accidentally avoided": include at
              least one test that would have failed before the change.
      - mentor_name: symbol_names
        prompt: |
          Can you help me ensure that all classes, methods, functions, variables, and fields modified by this CL have clear
          and descriptive names that follow best practices for the language they are written in?
      - mentor_name: vision
        prompt: |
          Can you help me check all code modified by this CL to ensure that the visibility modifiers (ex: public / private /
          protected for Java or just a leading underscore for private Dart symbols) of all classes, methods, and fields
          modified in this CL are appropriate? Make sure that no class, method, or field is more visible than it needs to
          be. For example, if a method is only used within its own class, it should be marked as private instead of public
          or protected. Dead code (unused public functionality that was added by this CL) should also be removed.
    file_globs:
      - "**/*.java"
      - "**/*.dart"
      - "**/*.acx.html"
  - profile_name: complete
    mentors:
      - mentor_name: complete
        run_on_wip: true
        prompt: |
          {% set chat_val = "#chat" -%}
          {%- set chat_clause = ", the initial conversation with Gemini that resulted in the creation of this CL (shown in the " ~ chat_val ~ " file)," if chat_val != "@" else "" -%}
          Can you help me ensure that this feature is functonally complete based off of the CL description (shown in the
          CL description file below){{ chat_clause }} and the file changes that have been made so far (shown in the diff file below)? Do
          NOT consider test completeness (we have other mentors for that).
    amend_note_regexes:
      - "Initial Commit"
      - "\\[mentor:complete\\]"
  - profile_name: i18n
    mentors:
      - mentor_name: i18n
        prompt: |
          Can you help me ensure that all user-facing strings introduced or modified in this CL are properly
          internationalized? Make sure that we favor performing internationalization directly in templates (see
          @third_party/dart_src/angular/g3doc/dev/i18n.md) instead of in Dart code files for short, simple strings.
    file_globs:
      - "**/*.dart"
      - "**/*.acx.html"
  - profile_name: pubfeat
    mentors:
      - mentor_name: pubfeat
        prompt: |
          Can you ensure that if this CL adds a new #feat that the value we used for the 'id' field is equal to the
          output of the `branch_number` command and that the value we used for the 'rollout_bug_id' field is equal to
          the output of the `cl_bug` command?
    file_globs:
      - "**/publisher_features.textproto"
  - profile_name: sql
    mentors:
      - mentor_name: sql
        prompt: |
          Can you help me ensure that the SQL files added by this CL have file paths of the form
          `configs/storage/f1/data_changes/gfp-f1-prod/input/*.sql` OR `configs/storage/f1/data_changes/gfp-f1-prod/input/gfp-f1-<team>/*.sql`,
          where `<team>` is the name of a team/domain (check to see which subdirectories exist)? We are only allowed to
          use the latter form when that subdirectory contains a README.md file that lists the name of the SQL table we
          are modifying; however, if that is the case, then you MUST use the latter form. You should also ensure that
          this CL adheres to the best practices described in the @contentads/gfp/agave/g3doc/modify/data_change.md file.
    file_globs:
      - "**/*.sql"
  - profile_name: ui
    mentors:
      - mentor_name: ui
        prompt: |
          Can you help me ensure that the changes made by this CL adhere to the guidelines outlined in the
          @contentads/drx/fe/client/g3doc/drx_ui_style.md document?
    file_globs:
      - "**/*.dart"
      - "**/*.acx.html"
      - "**/*.scss"
