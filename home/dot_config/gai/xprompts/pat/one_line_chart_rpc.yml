input: { create_plan: { type: bool, default: false } }
xprompts:
  base: |
    We need to improve the PA troubleshooting page by adding a line chart view in addition to the existing pie chart
    view. We need to make sure we only make one RPC to populate the data for the line chart and we have decided to use
    the OnePlatform Reporting API (in particular, the FetchReport method defined in the
    google/ads/admanager/main/reporting/report_service.proto file) to accomplish this.
  extra_reqs: |
    - We shouldn't show the pie chart and the line chart at the same time ever. So make sure the user has a way to
      toggle between the two.
    - This code lives somewhere in the
      contentads/drx/fe/client/trafficking/private_marketplace/components/deal_check_ui/ directory.
    - This functionality should all be gated behind the ENABLE_PA_TROUBLESHOOTING_IMPROVEMENTS #feat.
  file:
    input: { fname: word, query: text }
    content: |
      #_base {{ query }}

      #file:{{ fname }}
  research_files: |
    Some research has already been done to help you with this task. Review these files before deciding on your implementation approach:
      - OnePlatform Reporting API Research: @{{ research.api_research.file_path }}
      - Prior Art (Existing Dart Clients): @{{ research.prior_art.file_path }}
      - Required Dimensions and Metrics: @{{ research.dimensions_metrics.file_path }}
steps:
  # Step 1: Run 3 research agents in parallel
  - name: research
    parallel:
      - name: api_research
        output: { file_path: path }
        prompt: |
          #_file(api_research): Can you help me do some research on how the OnePlatform ReportService.FetchReport
          #service method works?

      - name: prior_art
        output: { file_path: path }
        prompt: |
          #_file(prior_art): Can you help me do some research on prior art in the form of other Dart clients that are
          currently using the OnePlatform Reporting API's FetchReport method?

      - name: dimensions_metrics
        output: { file_path: path }
        prompt: |
          #_file(dimensions_metrics): Can you help me do some research on what specific dimensions and metrics we need
          to query from Reporting?

  # Step 2: Plan agent creates an implementation plan
  - name: plan
    if: "{{ create_plan }}"
    output: { file_path: path }
    prompt: |
      #_file(plan): Can you help me write an implementation plan for this feature? Some extra requirements:

      #_extra_reqs

      #_research_files

  # Step 3: Implementation agent executes the plan
  - name: implementation
    prompt: |
      #_base

      #_extra_reqs

      {% if create_plan -%}
      Use the following implementation plan to inspire your approach: @{{ plan.file_path }}
      {% else -%}
      #_research_files
      {%- endif %}

      #commit:line_chart
