# Axe scheduler configuration.
axe:
  full_check_interval: 300
  comment_check_interval: 60
  hook_interval: 1
  zombie_timeout_seconds: 7200
  max_runners: 5

# Metahooks intercept failing hooks before the summarize agent runs.
metahooks:
  # keep-sorted start
  - name: hg_presubmit_tap
    hook_command: sase_presubmit
    output_regex: "[1-9]\\d* failed,"
  - name: scuba
    hook_command: bb_rabbit_test
    output_regex: "Expected: Scuba Result PASSED"
  # keep-sorted end

# Mentor profiles define which mentors to apply to which files.
mentor_profiles:
  # keep-sorted start
  - profile_name: aaa
    mentors:
      - prompt: "#mentor/aaa"
    file_globs:
      - "javatests/**/*.java"
      - "**/test*.dart"
  - profile_name: code
    mentors:
      - prompt: "#mentor/comments"
      - prompt: "#mentor/shared_code"
      - prompt: "#mentor/sound_tests"
        run_on_wip: true
      - prompt: "#mentor/symbol_names"
      - prompt: "#mentor/vision"
    file_globs:
      - "**/*.java"
      - "**/*.dart"
      - "**/*.acx.html"
  - profile_name: complete
    mentors:
      - prompt: "#mentor/complete"
        run_on_wip: true
    amend_note_regexes:
      - "Initial Commit"
      - "\\[mentor:complete\\]"
  - profile_name: g3doc
    mentors:
      - prompt: "#mentor/g3doc"
        run_on_wip: true
    file_globs:
      - "**/*.md"
  - profile_name: i18n
    mentors:
      - prompt: "#mentor/i18n"
    file_globs:
      - "**/*.dart"
      - "**/*.acx.html"
  - profile_name: pubfeat
    mentors:
      - prompt: "#mentor/pubfeat"
        run_on_wip: true
    file_globs:
      - "**/publisher_features.textproto"
  - profile_name: sql
    mentors:
      - prompt: "#mentor/sql"
        run_on_wip: true
    file_globs:
      - "**/*.sql"
  - profile_name: ui
    mentors:
      - prompt: "#mentor/ui"
    file_globs:
      - "**/*.dart"
      - "**/*.acx.html"
      - "**/*.scss"
  # keep-sorted end

# XPrompts are reusable text templates that can be referenced in prompts.
# Usage: #xprompt_name or #xprompt_name(arg1, arg2)
# Simple xprompts use string values, xprompts with arguments use input/content dicts.
xprompts:
  # keep-sorted start
  a:
    input: { note: { type: line, default: "" } }
    content: "#amend(note='{{ note }}')"
  b/ab:
    input: { bug_id: int, cl_name: word }
    content: |
      #b({{ bug_id }}, {{ cl_name }}) Refer to the 'How to add a Authorized Buyers' section of the @contentads/drx/fe/g3doc/indirect/bidders.md
      file to help you with this. #clref:852317975
  b:
    input: { bug_id: int, cl_name: word }
    content: "Can you help me fix the bug described by the #bug:{{ bug_id }} file? #commit({{ cl_name }}, {{ bug_id }})"
  bug:
    input: { bug_id: int }
    content: "#x(bug_desc, bugged show '{{ bug_id }}')"
  build: |
    Can you help me fix the build errors shown below, which were introduced by the current CL? #propose
  c:
    input: { name: word, bug_id: { type: int, default: 0 } }
    content: "#commit(name={{ name }}, bug_id={{ bug_id }})"
  chat: "@$(sase_first_commit_chat)"
  cl:
    input: { include_chat: { type: bool, default: false } }
    content: |
      ### Context Files Related to this CL
      + #cl_diff : Contains a diff of the changes made by the current CL.
      + #x(cl_desc, cl_desc --short) : Contains the current CL's change description.
      {%- if include_chat %}
      + #chat: Contains the initial conversation with Gemini that resulted in the creation of this CL.
      {%- endif %}
  cl_diff: |
    #x(cl_changes.diff, hg pdiff $(branch_changes | grep -v -E 'png$|fingerprint$') | perl -nE 'print s{google3/}{}gr')
  cl_local_diff: |
    #x(cl_changes.diff, hg diff $(branch_local_changes | grep -v -E 'png$|fingerprint$') | perl -nE 'print s{google3/}{}gr')
  clr:
    input: { cl_id: int }
    content: "cl/{{ cl_id }} (see the #x(cl_desc_and_diff.diff, p4 diff -c '{{ cl_id }}') file)"
  clref:
    input: { cl_id: int }
    content: "Use #clr:{{ cl_id }} as a reference."
  duck: "@$(printf '%s\\n' ~/bb/duckie/* | sort | tail -n 1)"
  duckie: "Make sure to use your ask-duckie tool to perform some research before deciding on a solution."
  duckref: "See the agent chat in #duck for some initial ideas."
  feat: >-
    publisher feature (see contentads/drx/fe/g3doc/admin/publisher_features.md for more information on publisher
    features)
  launch/beta:
    input: { bug_id: int, feature: word }
    content: |
      Can you help me enable the {{ feature }} #feat for the SMALL_BUSINESS_BETA (ID: 20) feature group?
      #clref:868137057 #commit(launch_beta, {{ bug_id }})
  launch/tests:
    input: { bug_id: int, feature: word }
    content: |
      Can you help me add the {{ feature }} #feat to FEATURE_GROUP_ALL in the TestPublisherFeatureGroups.java file? #commit(launch_tests, {{ bug_id }})
  mentor/aaa: |
    #mentor: Can you help me enforce the AAA (arrange, act, assert) test method structure? In particular, find and fix Any test
    method modified by this CL that does NOT structure its statements using the Arrange, Act, Assert pattern. There
    should NEVER be a blank line that breaks up one of these sections. Use comments if necessary to separate different
    parts of each section, but NEVER specify the section name using a comment (ex: '# Act'). When no section has more
    than 1 top-level (ex: not nested in a lambda expression block) statement, no blank lines are necessary. Otherwise,
    the sections should ALWAYS be separated by a blank line.
  mentor/comments: |
    #mentor: Can you help me ensure that all code changes in this CL follow best practices for code comments? Specifically,
    ensure that:
      + All public fields, functions, classes, and methods have clear and concise doc comments that follow best
        practices for the language they are written in. EXCEPTIONS:
          - Getters and setters do not need doc comments unless they have non-trivial logic.
          - If the best you can do is restate the name of the field, function, class, or method in the comment, then
            no comment is necessary.
      + We are critical about the comments we add â€” avoid redundant comments that simply restate what the code does.
  mentor/complete: |
    {% set chat_val = "#chat" -%}
    {%- set chat_clause = ", the initial conversation with Gemini that resulted in the creation of this CL (shown in the " ~ chat_val ~ " file)," if chat_val != "@" else "" -%}
    #mentor: Can you help me ensure that this feature is functonally complete based off of the CL description (shown in the
    CL description file below){{ chat_clause }} and the file changes that have been made so far (shown in the diff file below)? Do
    NOT consider test completeness (we have other mentors for that).
  mentor/g3doc: |
    #mentor: Can you help me ensure that markdown file changes in this CL adhere to the g3doc best practices outlined in
    the @corp/g3doc/docs/reference/style.md file?
  mentor/i18n: |
    #mentor: Can you help me ensure that all user-facing strings introduced or modified in this CL are properly
    internationalized? Make sure that we favor performing internationalization directly in templates (see
    @third_party/dart_src/angular/g3doc/dev/i18n.md) instead of in Dart code files for short, simple strings.
  mentor/pubfeat: |
    #mentor: Can you ensure that if this CL adds a new #feat that the value we used for the 'id' field is equal to the
    output of the `branch_number` command and that the value we used for the 'rollout_bug_id' field is equal to
    the output of the `cl_bug` command?
  mentor/shared_code: |
    #mentor: Can you help me identify any code that is duplicated across multiple files in this CL? You should use your
    CodeSearch tool to search for duplication and/or existing shared utilities across the codebase (related to the
    changes made in this CL). If you find any, please refactor the code to factor out a new shared utility / use the
    existing shared utility.
  mentor/sound_tests: |
    #mentor: Can you help me ensure that the changes made in this CL have proper test coverage? Specifically, you should
    verify that:
      + New logic comes with new or strengthened tests (or a clear justification for why existing tests are
        sufficient).
      + In the case of bug fixes, regressions are actively guarded against, not "accidentally avoided": include at
        least one test that would have failed before the change.
  mentor/sql: |
    #mentor: Can you help me ensure that the SQL files added by this CL have file paths of the form
    `configs/storage/f1/data_changes/gfp-f1-prod/input/*.sql` OR `configs/storage/f1/data_changes/gfp-f1-prod/input/gfp-f1-<team>/*.sql`,
    where `<team>` is the name of a team/domain (check to see which subdirectories exist)? We are only allowed to
    use the latter form when that subdirectory contains a README.md file that lists the name of the SQL table we
    are modifying; however, if that is the case, then you MUST use the latter form. You should also ensure that
    this CL adheres to the best practices described in the @contentads/gfp/agave/g3doc/modify/data_change.md file.
  mentor/symbol_names: |
    #mentor: Can you help me ensure that all classes, methods, functions, variables, and fields modified by this CL have clear
    and descriptive names that follow best practices for the language they are written in?
  mentor/ui: |
    #mentor: Can you help me ensure that the changes made by this CL adhere to the guidelines outlined in the
    @contentads/drx/fe/client/g3doc/drx_ui_style.md document?
  mentor/vision: |
    #mentor: Can you help me check all code modified by this CL to ensure that the visibility modifiers (ex: public / private /
    protected for Java or just a leading underscore for private Dart symbols) of all classes, methods, and fields
    modified in this CL are appropriate? Make sure that no class, method, or field is more visible than it needs to
    be. For example, if a method is only used within its own class, it should be marked as private instead of public
    or protected. Dead code (unused public functionality that was added by this CL) should also be removed.
  my_cl_desc_advice: |
    ### Advice for Writing CL Descriptions
    #### Use Bullets for Multiline CL Description Body
    Prefer bullets when constructing CL descriptions with multiple lines in the body. For example, consider the
    following CL description:

    ```
    Refactor FooModule Bar table modules and use proto-based field mappings.

    Remove manual field mappings for `name`, `label`, `type`, and `status` from
    `FooModule`, as these are now defined via annotations in `foo_messages.proto`.

    Consolidate module definitions by deleting `FooServiceBarModule` and merging its dependencies
    and scope into `FooModule`. This simplifies the configuration and ensures consistent usage
    across targets (e.g., Baz).

    Additionally, simplify `FooDtoConverter` by using `ignoreField` for `estimated_value` and
    `usage_percentage` instead of empty manual overrides.
    ```

    This is less desirable than:

    ```
    Refactor FooModule Bar table modules and use proto-based field mappings.

    - Remove manual field mappings for `name`, `label`, `type`, and `status` from `FooModule`,
      as these are now defined via annotations in `foo_messages.proto`.
    - Consolidate module definitions by deleting `FooServiceBarModule` and merging its dependencies and
      scope into `FooModule`. This simplifies the configuration and ensures consistent usage across
      targets (e.g., Baz).
    - Additionally, simplify `FooDtoConverter` by using `ignoreField` for `estimated_value` and
      `usage_percentage` instead of empty manual overrides.
    ```

    But prefer a single-sentence body over a multi-line body when it is sufficient to describe the change (don't delve too much into implementation details). For example, consider the following CL description:

    ```
    Use shared BarEnumConverters in FooEnumConverters.

    - Replace local definitions of `StatusConverter`, `FormatConverter`, and
      `TypeConverter` with shared implementations from `BarEnumConverters`
      to reduce code duplication and ensure consistency.
    - Remove the now-redundant inner classes from `FooEnumConverters.java`.
    - Update `BUILD` dependencies to include
      `//java/com/example/api/service/common/bar`.
    ```

    This is less desirable than:

    ```
    Use shared BarEnumConverters in FooEnumConverters.

    Remove local definitions of `StatusConverter`, `FormatConverter`, and `TypeConverter`
    from `FooEnumConverters` in favor of the shared implementations from `BarEnumConverters`.
    ```
  newfeat:
    input: { feat_name: word, usage: line }
    content: |
      Can you help me add a new #feat named {{ feat_name }} to the java/com/google/ads/publisher/domain/entity/feature/publisher_features.textproto file?
      This publisher feature will be used to {{ usage }}.
  noc: "Do NOT make any file changes."
  p:
    input: { note: { type: line, default: "" } }
    content: "#propose(note='{{ note }}')"
  presubmit:
    input: { output_path: path }
    content: |
      Can you help me fix the presubmit errors shown in the @{{ output_path }} file, which were introduced by the
      current CL? #propose
  reporting: |
    Refer to the `contentads/drx/reporting/g3doc/**/*.md` files for documentation on how the reporting stack works.
  sase_new_cl_desc: |
    Can you review the changes made by this CL (see the #cl_local_diff file) and suggest a new CL description that
    conforms with the advice given in the @~/bb/docs/cl_descriptions.md document? #my_cl_desc_advice
  scuba: "Make sure all related tests pass, except for some scuba diff tests, which are expected to fail."
  x:
    input: { name: word, cmd: line }
    content: "@$(xcmd {{ name }} {{ cmd }})"
  # keep-sorted end
