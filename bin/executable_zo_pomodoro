#!/bin/bash

source bugyi.sh

set -e

DATE=${DATE:-date}

function run() {
  local day_log_file="${HOME}"/org/$(${DATE} +%Y/%Y%m%d)_day.zo
  if ! [[ -f "${day_log_file}" ]]; then
    log::error "Today's day log file does NOT exist: %s" "${day_log_file}"
    return 1
  fi

  local output="$(get_pretty_pomodoro "${day_log_file}")"
  local ptime=$(echo "${output}" | cut -d' ' -f3)
  if [[ $(${DATE} +%H%M) -ge ${ptime} ]]; then
    output="[OVERDUE] ${output}"
  fi
  echo "${output}"
}

function get_pretty_pomodoro() {
  local zorg_file="$1"
  shift

  perl -nE 'print if /^======= p::/' "${zorg_file}" \
    | tail -n 1 \
    | perl -nE 'print s{.*::([1-9][0-9]*)\s+([012][0-9][0-5][0-9])}{P\1 @ \2}gr'
}

if [[ "${SCRIPTNAME}" == "$(basename "${BASH_SOURCE[0]}")" ]]; then
    run "$@"
fi
