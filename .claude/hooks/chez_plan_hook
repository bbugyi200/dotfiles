#!/bin/bash

# Notification hook for Claude Code planning mode
# Called by PreToolUse hooks for ExitPlanMode and AskUserQuestion
# Receives JSON via stdin with tool_name field

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_FILE="$SCRIPT_DIR/../hooks.log"

# Read JSON from stdin
INPUT=$(cat)

# Extract tool_name using jq (or grep if jq unavailable)
if command -v jq &>/dev/null; then
    TOOL_NAME=$(echo "$INPUT" | jq -r '.tool_name // empty')
else
    # Fallback: extract tool_name with grep/sed
    TOOL_NAME=$(echo "$INPUT" | grep -o '"tool_name":"[^"]*"' | sed 's/"tool_name":"\([^"]*\)"/\1/')
fi

# Log for debugging
echo "[$(date '+%Y-%m-%d %H:%M:%S')] chez_notify_hook: tool_name=$TOOL_NAME" >> "$LOG_FILE"

# Get tmux window for prefix (using TTY to find the correct window, not the focused one)
PREFIX="\[chez]"
current_tty=$(tty 2>/dev/null)
if [[ -n "$current_tty" ]]; then
    WINDOW=$(tmux list-panes -a -F '#{pane_tty} #{window_name}' 2>/dev/null | grep "^${current_tty} " | cut -d' ' -f2-)
    if [[ -n "$WINDOW" ]]; then
        PREFIX="\[chez#${WINDOW}]"
    fi
fi

# Set notification based on tool_name
case "$TOOL_NAME" in
    AskUserQuestion)
        TITLE="${PREFIX} Plan Question"
        MESSAGE="Claude is asking a question"
        ;;
    ExitPlanMode)
        TITLE="${PREFIX} Plan Complete"
        MESSAGE="Planning phase finished - ready for review"
        ;;
    *)
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] chez_notify_hook: unknown/empty tool: $TOOL_NAME" >> "$LOG_FILE"
        exit 0
        ;;
esac

# Send notification
echo "[$(date '+%Y-%m-%d %H:%M:%S')] chez_notify_hook: sending notification for $TOOL_NAME" >> "$LOG_FILE"
terminal-notifier -title "$TITLE" -message "$MESSAGE"

exit 0
