#!/bin/bash

# Notification hook for Claude Code planning mode
# Notifies user when Claude asks a question or completes the plan

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_FILE="$SCRIPT_DIR/../hooks.log"

# Read JSON input from stdin
INPUT=$(cat)

# Extract transcript_path and permission_mode from input
TRANSCRIPT_PATH=$(echo "$INPUT" | jq -r '.transcript_path')
PERMISSION_MODE=$(echo "$INPUT" | jq -r '.permission_mode')

# Log that this hook ran
echo "[$(date '+%Y-%m-%d %H:%M:%S')] chez_notify_hook ran (permission_mode=$PERMISSION_MODE, transcript=$TRANSCRIPT_PATH)" >> "$LOG_FILE"

# Only run in planning mode
if [[ "$PERMISSION_MODE" != "plan" ]]; then
    exit 0
fi

# Get tmux window for prefix (same pattern as chez_stop_hook)
PREFIX="\[chez]"
if WINDOW=$(tmux display-message -p '#W' 2>/dev/null); then
    PREFIX="\[chez#${WINDOW}]"
fi

# Function to determine stop type by parsing transcript
get_stop_type() {
    local transcript="$1"

    if [[ ! -f "$transcript" ]]; then
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] chez_notify_hook: transcript file not found: $transcript" >> "$LOG_FILE"
        echo "plan_complete"
        return
    fi

    # Get the last assistant message
    local last_msg
    last_msg=$(tac "$transcript" | grep -m1 '"type":"assistant".*"role":"assistant"')

    # Log what we found (truncate to 300 chars for readability)
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] chez_notify_hook: last_msg=${last_msg:0:300}" >> "$LOG_FILE"

    if [[ -z "$last_msg" ]]; then
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] chez_notify_hook: no assistant message found, defaulting to plan_complete" >> "$LOG_FILE"
        echo "plan_complete"
        return
    fi

    # Check for AskUserQuestion tool use
    if echo "$last_msg" | grep -q '"name":"AskUserQuestion"'; then
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] chez_notify_hook: detected AskUserQuestion" >> "$LOG_FILE"
        echo "question"
        return
    fi

    echo "[$(date '+%Y-%m-%d %H:%M:%S')] chez_notify_hook: no AskUserQuestion found, returning plan_complete" >> "$LOG_FILE"
    echo "plan_complete"
}

# Determine stop type
STOP_TYPE=$(get_stop_type "$TRANSCRIPT_PATH")

# Set notification title and message based on stop type
case "$STOP_TYPE" in
    question)
        TITLE="${PREFIX} Plan Question"
        MESSAGE="Claude is asking a question"
        ;;
    plan_complete)
        TITLE="${PREFIX} Plan Complete"
        MESSAGE="Planning phase finished - ready for review"
        ;;
esac

# Send notification
echo "[$(date '+%Y-%m-%d %H:%M:%S')] chez_notify_hook: sending notification - $TITLE: $MESSAGE" >> "$LOG_FILE"
terminal-notifier -title "$TITLE" -message "$MESSAGE"

# Exit success - never block, just notify
exit 0
