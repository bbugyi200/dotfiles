#!/bin/bash

# Directory containing this script (the .claude/hooks directory)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")"

# Print the command we are about to run.
function print_cmd_to_user() {
    local cmd="$1"
    shift
    echo "[chez_stop_hook] Running \`$cmd\`..."
}

# Format seconds as XhYmZs
function format_duration() {
    local total_seconds=$1
    local hours=$((total_seconds / 3600))
    local minutes=$(((total_seconds % 3600) / 60))
    local seconds=$((total_seconds % 60))
    if [[ "${hours}" != "0" ]]; then
        echo "${hours}h${minutes}m${seconds}s"
    elif [[ "${minutes}" != "0" ]]; then
        echo "${minutes}m${seconds}s"
    else
        echo "${seconds}s"
    fi
}

# Send Mac notification with result
function send_notification() {
    local passed=$1
    local elapsed_seconds=$2
    local errors="$3"

    local title
    local message

    if [ "$passed" = "true" ]; then
        title='\[chezmoi] Stop Hook - PASSED'
        message="RUNTIME: $(format_duration "$elapsed_seconds")"
    else
        title='\[chezmoi] Stop Hook - FAILED'
        message="$errors"
    fi

    terminal-notifier -title "$title" -message "$message"
}

# Run quality checks: make fix, lint, tests
function run() {
    cd "$PROJECT_DIR" || return 1

    # Track start time for notification
    local start_time
    start_time=$(date +%s)

    # Log that this hook ran
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] chez_stop_hook ran" >>"$SCRIPT_DIR/../hooks.log"

    # Apply chezmoi changes first
    print_cmd_to_user "chezmoi apply --force"
    chezmoi apply --force

    # Collect errors
    local errors=""
    local output

    # Run make lint
    print_cmd_to_user "make lint"
    if ! output=$(make lint 2>&1); then
        errors+="make lint FAILED:\n$output\n\n"
    fi

    # Run tests - nvim tests can hang after completion, so use short timeout
    # The actual tests complete in ~3s but nvim doesn't exit cleanly
    print_cmd_to_user "make test-nvim"
    if ! output=$(timeout 30 make test-nvim 2>&1); then
        local exit_code=$?
        # Only report if it's not just the timeout killing hanging nvim
        if [ $exit_code -ne 124 ]; then
            errors+="make test-nvim FAILED:\n$output\n\n"
        else
            # Timeout occurred - check if tests passed before timeout
            if ! echo "$output" | grep -q "0 failures"; then
                errors+="make test-nvim FAILED (or hung before completing):\n$output\n\n"
            fi
        fi
    fi

    # Run bash tests
    print_cmd_to_user "make test-bash"
    if ! output=$(make test-bash 2>&1); then
        errors+="make test-bash FAILED:\n$output\n\n"
    fi

    # Run python tests (can take 60+ seconds)
    print_cmd_to_user "make test-python"
    if ! output=$(timeout 120 make test-python 2>&1); then
        exit_code=$?
        if [ $exit_code -eq 124 ]; then
            errors+="make test-python TIMED OUT after 120 seconds\n\n"
        else
            errors+="make test-python FAILED:\n$output\n\n"
        fi
    fi

    # Calculate elapsed time
    local end_time elapsed_seconds
    end_time=$(date +%s)
    elapsed_seconds=$((end_time - start_time))

    # If any errors occurred, block and report
    if [ -n "$errors" ]; then
        send_notification "false" "$elapsed_seconds" "$errors"
        echo -e "$errors" >&2
        return 2 # Exit code 2 blocks Claude and shows stderr
    fi

    send_notification "true" "$elapsed_seconds" ""
    return 0
}

run "$@"
